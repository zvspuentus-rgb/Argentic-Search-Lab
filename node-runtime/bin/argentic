#!/usr/bin/env bash
set -euo pipefail

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
RUN_DIR="$ROOT_DIR/.run"
NODE_PID_FILE="$RUN_DIR/node.pid"
SEARX_PID_FILE="$RUN_DIR/searx.pid"
SEARX_PORT_FILE="$RUN_DIR/searx_port"
NODE_PORT="${PORT:-3093}"
SEARX_PORT="${SEARX_PORT:-8394}"

cmd="${1:-up}"

case "$cmd" in
  up|start)
    exec "$ROOT_DIR/scripts/start-all.sh"
    ;;
  down|stop)
    if [[ -f "$NODE_PID_FILE" ]]; then
      pid="$(cat "$NODE_PID_FILE" || true)"
      if [[ -n "$pid" ]] && kill -0 "$pid" >/dev/null 2>&1; then
        kill "$pid" >/dev/null 2>&1 || true
      fi
      rm -f "$NODE_PID_FILE"
    else
      lsof -ti tcp:"$NODE_PORT" | xargs -r kill -9
    fi
    if [[ -f "$SEARX_PID_FILE" ]]; then
      spid="$(cat "$SEARX_PID_FILE" || true)"
      if [[ -n "$spid" ]] && kill -0 "$spid" >/dev/null 2>&1; then
        kill "$spid" >/dev/null 2>&1 || true
      fi
      rm -f "$SEARX_PID_FILE"
    fi
    echo "[argentic] stopped"
    ;;
  status)
    if [[ -f "$SEARX_PORT_FILE" ]]; then
      saved="$(cat "$SEARX_PORT_FILE" 2>/dev/null || true)"
      if [[ -n "${saved:-}" ]]; then
        SEARX_PORT="$saved"
      fi
    fi
    if curl -fsS "http://localhost:${NODE_PORT}/health" >/dev/null 2>&1; then
      echo "[argentic] UI/MCP: up (http://localhost:${NODE_PORT})"
    else
      echo "[argentic] UI/MCP: down"
    fi

    if curl -fsS "http://localhost:${SEARX_PORT}/search?q=health&format=json" >/dev/null 2>&1; then
      echo "[argentic] SearXNG: up (http://localhost:${SEARX_PORT})"
    else
      echo "[argentic] SearXNG: down"
    fi
    ;;
  *)
    echo "Usage: argentic [up|down|status]"
    exit 1
    ;;
esac
